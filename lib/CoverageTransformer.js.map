{"version":3,"sources":["../src/CoverageTransformer.js"],"names":["require","Collector","path","fs","SourceMapConsumer","sourceMapRegEx","SparceCoverageCollector","getMapping","remapFunction","remapBranch","CoverageTransformer","options","basePath","warn","console","exclude","fileName","indexOf","match","useAbsolutePaths","readJSON","filePath","existsSync","Error","JSON","parse","readFileSync","readFile","sourceStore","sources","sparceCoverageCollector","fileCoverage","codeIsArray","codeFromFile","jsText","code","Array","isArray","join","exec","sourceMapDir","dirname","rawSourceMap","inputSourceMap","Buffer","toString","sourceMapPath","String","split","error","setCoverage","map","srcPath","substr","resolve","sourceMap","inlineSourceMap","origSourceFilename","origFileName","sourcesContent","extname","file","replace","sourceRoot","forEach","source","idx","setSourceCode","set","resolvePath","resolvedSource","relative","process","cwd","getMappingResolved","location","mapping","branchMap","index","genItem","hits","b","info","updateBranch","srcItem","fnMap","f","updateFunction","statementMap","s","updateStatement","loc","srcCoverage","getFinalCoverage","getPath","absolutePath","fullSourceMapPath","item","addFileCoverage","collector","add","filter","reduce","obj","name","module","exports"],"mappings":";;;;;;;;;;;;;;;;;;;;eAAsBA,QAAQ,UAAR,C;IAAdC,S,YAAAA,S;;AACR,IAAMC,OAAOF,QAAQ,MAAR,CAAb;AACA,IAAMG,KAAKH,QAAQ,IAAR,CAAX;;gBAC8BA,QAAQ,YAAR,C;IAAtBI,iB,aAAAA,iB;;AAER,IAAMC,iBAAiB,kFAAvB;;AAEA,IAAMC,0BAA0BN,QAAQ,2BAAR,EAAqCM,uBAArE;;AAEA,IAAMC,aAAaP,QAAQ,cAAR,CAAnB;;AAEA,IAAMQ,gBAAgBR,QAAQ,iBAAR,CAAtB;AACA,IAAMS,cAAcT,QAAQ,eAAR,CAApB;;IAGMU,mB;AACL,8BAAYC,OAAZ,EAAqB;AAAA;;AACpB,OAAKC,QAAL,GAAgBD,QAAQC,QAAxB;AACA,OAAKC,IAAL,GAAYF,QAAQE,IAAR,IAAgBC,QAAQD,IAApC;;AAEA,OAAKE,OAAL,GAAe;AAAA,UAAM,KAAN;AAAA,GAAf;AACA,MAAIJ,QAAQI,OAAZ,EAAqB;AACpB,OAAI,OAAOJ,QAAQI,OAAf,KAA2B,UAA/B,EAA2C;AAC1C,SAAKA,OAAL,GAAeJ,QAAQI,OAAvB;AACA,IAFD,MAEO,IAAI,OAAOJ,QAAQI,OAAf,KAA2B,QAA/B,EAAyC;AAC/C,SAAKA,OAAL,GAAe,UAACC,QAAD;AAAA,YAAcA,SAASC,OAAT,CAAiBN,QAAQI,OAAzB,IAAoC,CAAC,CAAnD;AAAA,KAAf;AACA,IAFM,MAEA;AACN,SAAKA,OAAL,GAAe,UAACC,QAAD;AAAA,YAAcA,SAASE,KAAT,CAAeP,QAAQI,OAAvB,CAAd;AAAA,KAAf;AACA;AACD;;AAED,OAAKI,gBAAL,GAAwB,CAAC,CAACR,QAAQQ,gBAAlC;;AAEA,OAAKC,QAAL,GAAgBT,QAAQS,QAAR,IACZ,SAASA,QAAT,CAAkBC,QAAlB,EAA4B;AAC9B,OAAI,CAAClB,GAAGmB,UAAH,CAAcD,QAAd,CAAL,EAA8B;AAC7B,SAAKR,IAAL,CAAUU,iCAA+BF,QAA/B,OAAV;AACA,WAAO,IAAP;AACA;AACD,UAAOG,KAAKC,KAAL,CAAWtB,GAAGuB,YAAH,CAAgBL,QAAhB,CAAX,CAAP;AACA,GAPF;;AASA,OAAKM,QAAL,GAAgBhB,QAAQgB,QAAR,IACZ,SAASA,QAAT,CAAkBN,QAAlB,EAA4B;AAC9B,OAAI,CAAClB,GAAGmB,UAAH,CAAcD,QAAd,CAAL,EAA8B;AAC7B,SAAKR,IAAL,CAAU,IAAIU,KAAJ,4BAAmCF,QAAnC,OAAV;AACA,WAAO,EAAP;AACA;AACD,UAAOlB,GAAGuB,YAAH,CAAgBL,QAAhB,CAAP;AACA,GAPF;;AASA,OAAKO,WAAL,GAAmBjB,QAAQkB,OAA3B;;AAEA,OAAKC,uBAAL,GAA+B,IAAIxB,uBAAJ,EAA/B;AACA;;;;kCAEee,Q,EAAUU,Y,EAAc;AAAA;;AACvC,OAAI,KAAKhB,OAAL,CAAaM,QAAb,CAAJ,EAA4B;AAC3B,SAAKR,IAAL,kBAAyBQ,QAAzB;AACA;AACA;;AAED;AACA,OAAIW,cAAc,IAAlB;AACA,OAAIC,eAAe,KAAnB;AACA,OAAIC,SAASH,aAAaI,IAA1B;AACA,OAAI,CAACD,MAAL,EAAa;AACZA,aAAS,KAAKP,QAAL,CAAcN,QAAd,CAAT;AACAY,mBAAe,IAAf;AACA;AACD,OAAIG,MAAMC,OAAN,CAAcH,MAAd,CAAJ,EAA2B;AAAE;AAC5BA,aAASA,OAAOI,IAAP,CAAY,IAAZ,CAAT;AACA,IAFD,MAEO;AACNN,kBAAc,KAAd;AACA;AACD,OAAId,QAAQb,eAAekC,IAAf,CAAoBL,MAApB,CAAZ;AACA,OAAIM,eAAetC,KAAKuC,OAAL,CAAapB,QAAb,CAAnB;AACA,OAAIqB,qBAAJ;;AAEA,OAAIX,aAAaY,cAAjB,EAAiC;AAChCD,mBAAeX,aAAaY,cAA5B;AACA,IAFD,MAEO,IAAI,CAACzB,KAAD,IAAU,CAACe,YAAf,EAA6B;AACnCD,kBAAc,KAAd;AACAE,aAAS,KAAKP,QAAL,CAAcN,QAAd,CAAT;AACAH,YAAQb,eAAekC,IAAf,CAAoBL,MAApB,CAAR;AACA;;AAED,OAAIhB,KAAJ,EAAW;AACV,QAAIA,MAAM,CAAN,CAAJ,EAAc;AACbwB,oBAAelB,KAAKC,KAAL,CAAY,IAAImB,MAAJ,CAAW1B,MAAM,CAAN,CAAX,EAAqB,QAArB,EAA+B2B,QAA/B,CAAwC,MAAxC,CAAZ,CAAf;AACA,KAFD,MAEO;AACN,SAAMC,gBAAgB5C,KAAKoC,IAAL,CAAUE,YAAV,EAAwBtB,MAAM,CAAN,CAAxB,CAAtB;AACAwB,oBAAe,KAAKtB,QAAL,CAAc0B,aAAd,CAAf;AACAN,oBAAetC,KAAKuC,OAAL,CAAaK,aAAb,CAAf;AACA;AACD;;AAED,OAAI,CAACJ,YAAL,EAAmB;AAClB;AACA,SAAK7B,IAAL,CAAU,IAAIU,KAAJ,sCAA6CF,QAA7C,OAAV;AACA,QAAI;AACHU,kBAAaI,IAAb,GAAoBY,OAAO5C,GAAGuB,YAAH,CAAgBL,QAAhB,CAAP,EAAkC2B,KAAlC,CAAwC,IAAxC,CAApB;AACA,KAFD,CAEE,OAAOC,KAAP,EAAc;AACf,UAAKpC,IAAL,CAAU,IAAIU,KAAJ,+BAAsCF,QAAtC,OAAV;AACA;AACD,SAAKS,uBAAL,CAA6BoB,WAA7B,CAAyC7B,QAAzC,EAAmDU,YAAnD;AACA;AACA;;AAEDS,kBAAe,KAAK5B,QAAL,IAAiB4B,YAAhC;;AAEA;AACAE,gBAAab,OAAb,GAAuBa,aAAab,OAAb,CAAqBsB,GAArB,CAAyB,UAACC,OAAD;AAAA,WAC/CA,QAAQC,MAAR,CAAe,CAAf,EAAkB,CAAlB,MAAyB,GAAzB,GACGnD,KAAKoD,OAAL,CAAad,YAAb,EAA2BY,OAA3B,CADH,GAEGA,OAH4C;AAAA,IAAzB,CAAvB;;AAMA,OAAIG,YAAY,IAAInD,iBAAJ,CAAsBsC,YAAtB,CAAhB;;AAEA;AACA,OAAMc,kBAAkB,EAAxB;AACA,OAAIC,2BAAJ;AACA,OAAIC,qBAAJ;AACA,OAAI1C,iBAAJ;;AAEA,OAAIuC,UAAUI,cAAd,EAA8B;AAC7BF,yBAAqBf,aAAab,OAAb,CAAqB,CAArB,CAArB;;AAEA,QAAI4B,sBAAsBvD,KAAK0D,OAAL,CAAaH,kBAAb,MAAqC,EAA/D,EAAmE;AAClEC,oBAAehB,aAAamB,IAA5B;AACA7C,gBAAWK,SAASyC,OAAT,CAAiB5D,KAAK0D,OAAL,CAAaF,YAAb,CAAjB,EAA6CxD,KAAK0D,OAAL,CAAaH,kBAAb,CAA7C,CAAX;AACAf,kBAAamB,IAAb,GAAoB7C,QAApB;AACA0B,kBAAab,OAAb,GAAuB,CAACb,QAAD,CAAvB;AACA0B,kBAAaqB,UAAb,GAA0B,EAA1B;AACAR,iBAAY,IAAInD,iBAAJ,CAAsBsC,YAAtB,CAAZ;AACA;;AAEDa,cAAUI,cAAV,CAAyBK,OAAzB,CAAiC,UAACC,MAAD,EAASC,GAAT,EAAiB;AACjDV,qBAAgBD,UAAU1B,OAAV,CAAkBqC,GAAlB,CAAhB,IAA0C,IAA1C;AACA,WAAKpC,uBAAL,CAA6BqC,aAA7B,CACCZ,UAAU1B,OAAV,CAAkBqC,GAAlB,CADD,EAEClC,cAAciC,OAAOjB,KAAP,CAAa,IAAb,CAAd,GAAmCiB,MAFpC;AAIA,SAAI,MAAKrC,WAAT,EAAsB;AACrB,YAAKA,WAAL,CAAiBwC,GAAjB,CAAqBb,UAAU1B,OAAV,CAAkBqC,GAAlB,CAArB,EAA6CD,MAA7C;AACA;AACD,KATD;AAUA;;AAED,OAAMI,cAAc,SAAdA,WAAc,CAACJ,MAAD,EAAY;AAC/B,QAAIK,iBAAiBL,UAAUT,eAAV,GAClBS,MADkB,GAElB/D,KAAKoD,OAAL,CAAad,YAAb,EAA2ByB,MAA3B,CAFH;;AAIA,QAAI,CAAC,MAAK9C,gBAAN,IAA0B,EAAE8C,UAAUT,eAAZ,CAA9B,EAA4D;AAC3Dc,sBAAiBpE,KAAKqE,QAAL,CAAcC,QAAQC,GAAR,EAAd,EAA6BH,cAA7B,CAAjB;AACA;AACD,WAAOA,cAAP;AACA,IATD;;AAWA,OAAMI,qBAAqB,SAArBA,kBAAqB,CAACC,QAAD,EAAc;AACxC,QAAMC,UAAUrE,WAAWgD,SAAX,EAAsBoB,QAAtB,CAAhB;AACA,QAAI,CAACC,OAAL,EAAc,OAAO,IAAP;;AAEd,WAAO,sBAAcA,OAAd,EAAuB,EAAEX,QAAQI,YAAYO,QAAQX,MAApB,CAAV,EAAvB,CAAP;AACA,IALD;;AAOA,uBAAYlC,aAAa8C,SAAzB,EAAoCb,OAApC,CAA4C,UAACc,KAAD,EAAW;AACtD,QAAMC,UAAUhD,aAAa8C,SAAb,CAAuBC,KAAvB,CAAhB;AACA,QAAME,OAAOjD,aAAakD,CAAb,CAAeH,KAAf,CAAb;;AAEA,QAAMI,OAAOzE,YAAYsE,OAAZ,EAAqBL,kBAArB,CAAb;;AAEA,QAAIQ,IAAJ,EAAU;AACT,WAAKpD,uBAAL,CAA6BqD,YAA7B,CAA0CD,KAAKjB,MAA/C,EAAuDiB,KAAKE,OAA5D,EAAqEJ,IAArE;AACA;AACD,IATD;;AAWA,uBAAYjD,aAAasD,KAAzB,EAAgCrB,OAAhC,CAAwC,UAACc,KAAD,EAAW;AAClD,QAAMC,UAAUhD,aAAasD,KAAb,CAAmBP,KAAnB,CAAhB;AACA,QAAME,OAAOjD,aAAauD,CAAb,CAAeR,KAAf,CAAb;;AAEA,QAAMI,OAAO1E,cAAcuE,OAAd,EAAuBL,kBAAvB,CAAb;;AAEA,QAAIQ,IAAJ,EAAU;AACT,WAAKpD,uBAAL,CAA6ByD,cAA7B,CAA4CL,KAAKjB,MAAjD,EAAyDiB,KAAKE,OAA9D,EAAuEJ,IAAvE;AACA;AACD,IATD;;AAWA,uBAAYjD,aAAayD,YAAzB,EAAuCxB,OAAvC,CAA+C,UAACc,KAAD,EAAW;AACzD,QAAMC,UAAUhD,aAAayD,YAAb,CAA0BV,KAA1B,CAAhB;AACA,QAAME,OAAOjD,aAAa0D,CAAb,CAAeX,KAAf,CAAb;;AAEA,QAAMF,UAAUF,mBAAmBK,OAAnB,CAAhB;;AAEA,QAAIH,OAAJ,EAAa;AACZ,WAAK9C,uBAAL,CAA6B4D,eAA7B,CAA6Cd,QAAQX,MAArD,EAA6DW,QAAQe,GAArE,EAA0EX,IAA1E;AACA;AACD,IATD;;AAWA;AACA,OAAMY,cAAc,KAAK9D,uBAAL,CAA6B+D,gBAA7B,EAApB;;AAEA,OAAItC,UAAUI,cAAV,IAA4B,KAAK/C,QAArC,EAA+C;AAC9C;AACA,QAAMkF,UAAU,SAAVA,OAAU,WAAY;AAC3B,SAAMC,eAAe7F,KAAKoD,OAAL,CAAa,MAAK1C,QAAlB,EAA4BS,QAA5B,CAArB;AACA,SAAI,CAAC,MAAKF,gBAAV,EAA4B;AAC3B,aAAOjB,KAAKqE,QAAL,CAAcC,QAAQC,GAAR,EAAd,EAA6BsB,YAA7B,CAAP;AACA;AACD,YAAOA,YAAP;AACA,KAND;AAOA,QAAMC,oBAAoBF,QACzBpC,aAAaI,OAAb,CAAqB5D,KAAK0D,OAAL,CAAaF,YAAb,CAArB,EAAiDxD,KAAK0D,OAAL,CAAaH,kBAAb,CAAjD,CADyB,CAA1B;AAGAmC,gBAAYI,iBAAZ,IAAiCJ,YAAY5E,QAAZ,CAAjC;AACA4E,gBAAYI,iBAAZ,EAA+B9F,IAA/B,GAAsC8F,iBAAtC;AACA,WAAOJ,YAAY5E,QAAZ,CAAP;AACA;AACD;;;8BAEWiF,I,EAAM;AAAA;;AACjB,uBAAYA,IAAZ,EACEjC,OADF,CACU,UAAC3C,QAAD,EAAc;AACtB,QAAMU,eAAekE,KAAK5E,QAAL,CAArB;AACA,WAAK6E,eAAL,CAAqB7E,QAArB,EAA+BU,YAA/B;AACA,IAJF;AAKA;;;qCAEkB;AAAA;;AAClB,OAAMoE,YAAY,IAAIlG,SAAJ,EAAlB;;AAEA,OAAM2F,cAAc,KAAK9D,uBAAL,CAA6B+D,gBAA7B,EAApB;;AAEAM,aAAUC,GAAV,CAAc,oBAAYR,WAAZ,EACZS,MADY,CACL,UAAChF,QAAD;AAAA,WAAc,CAAC,OAAKN,OAAL,CAAaM,QAAb,CAAf;AAAA,IADK,EAEZiF,MAFY,CAEL,UAACC,GAAD,EAAMC,IAAN,EAAe;AACtBD,QAAIC,IAAJ,IAAYZ,YAAYY,IAAZ,CAAZ;AACA,WAAOD,GAAP;AACA,IALY,EAKV,EALU,CAAd;;AAOA;AACAJ,aAAUN,gBAAV;;AAEA,UAAOM,SAAP;AACA;;;;;AAGFM,OAAOC,OAAP,CAAehG,mBAAf,GAAqCA,mBAArC","file":"CoverageTransformer.js","sourcesContent":["const { Collector } = require('istanbul');\r\nconst path = require('path');\r\nconst fs = require('fs');\r\nconst { SourceMapConsumer } = require('source-map');\r\n\r\nconst sourceMapRegEx = /(?:\\/{2}[#@]{1,2}|\\/\\*)\\s+sourceMappingURL\\s*=\\s*(data:(?:[^;]+;)+base64,)?(\\S+)/;\r\n\r\nconst SparceCoverageCollector = require('./SparceCoverageCollector').SparceCoverageCollector;\r\n\r\nconst getMapping = require('./getMapping');\r\n\r\nconst remapFunction = require('./remapFunction');\r\nconst remapBranch = require('./remapBranch');\r\n\r\n\r\nclass CoverageTransformer {\r\n\tconstructor(options) {\r\n\t\tthis.basePath = options.basePath;\r\n\t\tthis.warn = options.warn || console.warn;\r\n\r\n\t\tthis.exclude = () => false;\r\n\t\tif (options.exclude) {\r\n\t\t\tif (typeof options.exclude === 'function') {\r\n\t\t\t\tthis.exclude = options.exclude;\r\n\t\t\t} else if (typeof options.exclude === 'string') {\r\n\t\t\t\tthis.exclude = (fileName) => fileName.indexOf(options.exclude) > -1;\r\n\t\t\t} else {\r\n\t\t\t\tthis.exclude = (fileName) => fileName.match(options.exclude);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis.useAbsolutePaths = !!options.useAbsolutePaths;\r\n\r\n\t\tthis.readJSON = options.readJSON\r\n\t\t\t|| function readJSON(filePath) {\r\n\t\t\t\tif (!fs.existsSync(filePath)) {\r\n\t\t\t\t\tthis.warn(Error(`Could not find file: \"${filePath}\"`));\r\n\t\t\t\t\treturn null;\r\n\t\t\t\t}\r\n\t\t\t\treturn JSON.parse(fs.readFileSync(filePath));\r\n\t\t\t};\r\n\r\n\t\tthis.readFile = options.readFile\r\n\t\t\t|| function readFile(filePath) {\r\n\t\t\t\tif (!fs.existsSync(filePath)) {\r\n\t\t\t\t\tthis.warn(new Error(`Could not find file: \"${filePath}\"`));\r\n\t\t\t\t\treturn '';\r\n\t\t\t\t}\r\n\t\t\t\treturn fs.readFileSync(filePath);\r\n\t\t\t};\r\n\r\n\t\tthis.sourceStore = options.sources;\r\n\r\n\t\tthis.sparceCoverageCollector = new SparceCoverageCollector();\r\n\t}\r\n\r\n\taddFileCoverage(filePath, fileCoverage) {\r\n\t\tif (this.exclude(filePath)) {\r\n\t\t\tthis.warn(`Excluding: \"${filePath}\"`);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t/* coverage.json can sometimes include the code inline */\r\n\t\tlet codeIsArray = true;\r\n\t\tlet codeFromFile = false;\r\n\t\tlet jsText = fileCoverage.code;\r\n\t\tif (!jsText) {\r\n\t\t\tjsText = this.readFile(filePath);\r\n\t\t\tcodeFromFile = true;\r\n\t\t}\r\n\t\tif (Array.isArray(jsText)) { /* sometimes the source is an array */\r\n\t\t\tjsText = jsText.join('\\n');\r\n\t\t} else {\r\n\t\t\tcodeIsArray = false;\r\n\t\t}\r\n\t\tlet match = sourceMapRegEx.exec(jsText);\r\n\t\tlet sourceMapDir = path.dirname(filePath);\r\n\t\tlet rawSourceMap;\r\n\r\n\t\tif (fileCoverage.inputSourceMap) {\r\n\t\t\trawSourceMap = fileCoverage.inputSourceMap;\r\n\t\t} else if (!match && !codeFromFile) {\r\n\t\t\tcodeIsArray = false;\r\n\t\t\tjsText = this.readFile(filePath);\r\n\t\t\tmatch = sourceMapRegEx.exec(jsText);\r\n\t\t}\r\n\r\n\t\tif (match) {\r\n\t\t\tif (match[1]) {\r\n\t\t\t\trawSourceMap = JSON.parse((new Buffer(match[2], 'base64').toString('utf8')));\r\n\t\t\t} else {\r\n\t\t\t\tconst sourceMapPath = path.join(sourceMapDir, match[2]);\r\n\t\t\t\trawSourceMap = this.readJSON(sourceMapPath);\r\n\t\t\t\tsourceMapDir = path.dirname(sourceMapPath);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (!rawSourceMap) {\r\n\t\t\t/* We couldn't find a source map, so will copy coverage after warning. */\r\n\t\t\tthis.warn(new Error(`Could not find source map for: \"${filePath}\"`));\r\n\t\t\ttry {\r\n\t\t\t\tfileCoverage.code = String(fs.readFileSync(filePath)).split('\\n');\r\n\t\t\t} catch (error) {\r\n\t\t\t\tthis.warn(new Error(`Could find source for : \"${filePath}\"`));\r\n\t\t\t}\r\n\t\t\tthis.sparceCoverageCollector.setCoverage(filePath, fileCoverage);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tsourceMapDir = this.basePath || sourceMapDir;\r\n\r\n\t\t// replace relative paths in source maps with absolute\r\n\t\trawSourceMap.sources = rawSourceMap.sources.map((srcPath) => (\r\n\t\t\tsrcPath.substr(0, 1) === '.'\r\n\t\t\t\t? path.resolve(sourceMapDir, srcPath)\r\n\t\t\t\t: srcPath\r\n\t\t));\r\n\r\n\t\tlet sourceMap = new SourceMapConsumer(rawSourceMap);\r\n\r\n\t\t/* if there are inline sources and a store to put them into, we will populate it */\r\n\t\tconst inlineSourceMap = {};\r\n\t\tlet origSourceFilename;\r\n\t\tlet origFileName;\r\n\t\tlet fileName;\r\n\r\n\t\tif (sourceMap.sourcesContent) {\r\n\t\t\torigSourceFilename = rawSourceMap.sources[0];\r\n\r\n\t\t\tif (origSourceFilename && path.extname(origSourceFilename) !== '') {\r\n\t\t\t\torigFileName = rawSourceMap.file;\r\n\t\t\t\tfileName = filePath.replace(path.extname(origFileName), path.extname(origSourceFilename));\r\n\t\t\t\trawSourceMap.file = fileName;\r\n\t\t\t\trawSourceMap.sources = [fileName];\r\n\t\t\t\trawSourceMap.sourceRoot = '';\r\n\t\t\t\tsourceMap = new SourceMapConsumer(rawSourceMap);\r\n\t\t\t}\r\n\r\n\t\t\tsourceMap.sourcesContent.forEach((source, idx) => {\r\n\t\t\t\tinlineSourceMap[sourceMap.sources[idx]] = true;\r\n\t\t\t\tthis.sparceCoverageCollector.setSourceCode(\r\n\t\t\t\t\tsourceMap.sources[idx],\r\n\t\t\t\t\tcodeIsArray ? source.split('\\n') : source\r\n\t\t\t\t);\r\n\t\t\t\tif (this.sourceStore) {\r\n\t\t\t\t\tthis.sourceStore.set(sourceMap.sources[idx], source);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tconst resolvePath = (source) => {\r\n\t\t\tlet resolvedSource = source in inlineSourceMap\r\n\t\t\t\t? source\r\n\t\t\t\t: path.resolve(sourceMapDir, source);\r\n\r\n\t\t\tif (!this.useAbsolutePaths && !(source in inlineSourceMap)) {\r\n\t\t\t\tresolvedSource = path.relative(process.cwd(), resolvedSource);\r\n\t\t\t}\r\n\t\t\treturn resolvedSource;\r\n\t\t};\r\n\r\n\t\tconst getMappingResolved = (location) => {\r\n\t\t\tconst mapping = getMapping(sourceMap, location);\r\n\t\t\tif (!mapping) return null;\r\n\r\n\t\t\treturn Object.assign(mapping, { source: resolvePath(mapping.source) });\r\n\t\t};\r\n\r\n\t\tObject.keys(fileCoverage.branchMap).forEach((index) => {\r\n\t\t\tconst genItem = fileCoverage.branchMap[index];\r\n\t\t\tconst hits = fileCoverage.b[index];\r\n\r\n\t\t\tconst info = remapBranch(genItem, getMappingResolved);\r\n\r\n\t\t\tif (info) {\r\n\t\t\t\tthis.sparceCoverageCollector.updateBranch(info.source, info.srcItem, hits);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tObject.keys(fileCoverage.fnMap).forEach((index) => {\r\n\t\t\tconst genItem = fileCoverage.fnMap[index];\r\n\t\t\tconst hits = fileCoverage.f[index];\r\n\r\n\t\t\tconst info = remapFunction(genItem, getMappingResolved);\r\n\r\n\t\t\tif (info) {\r\n\t\t\t\tthis.sparceCoverageCollector.updateFunction(info.source, info.srcItem, hits);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tObject.keys(fileCoverage.statementMap).forEach((index) => {\r\n\t\t\tconst genItem = fileCoverage.statementMap[index];\r\n\t\t\tconst hits = fileCoverage.s[index];\r\n\r\n\t\t\tconst mapping = getMappingResolved(genItem);\r\n\r\n\t\t\tif (mapping) {\r\n\t\t\t\tthis.sparceCoverageCollector.updateStatement(mapping.source, mapping.loc, hits);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// todo: refactor exposing implementation details\r\n\t\tconst srcCoverage = this.sparceCoverageCollector.getFinalCoverage();\r\n\r\n\t\tif (sourceMap.sourcesContent && this.basePath) {\r\n\t\t\t// Convert path to use base path option\r\n\t\t\tconst getPath = filePath => {\r\n\t\t\t\tconst absolutePath = path.resolve(this.basePath, filePath);\r\n\t\t\t\tif (!this.useAbsolutePaths) {\r\n\t\t\t\t\treturn path.relative(process.cwd(), absolutePath);\r\n\t\t\t\t}\r\n\t\t\t\treturn absolutePath;\r\n\t\t\t};\r\n\t\t\tconst fullSourceMapPath = getPath(\r\n\t\t\t\torigFileName.replace(path.extname(origFileName), path.extname(origSourceFilename))\r\n\t\t\t);\r\n\t\t\tsrcCoverage[fullSourceMapPath] = srcCoverage[fileName];\r\n\t\t\tsrcCoverage[fullSourceMapPath].path = fullSourceMapPath;\r\n\t\t\tdelete srcCoverage[fileName];\r\n\t\t}\r\n\t}\r\n\r\n\taddCoverage(item) {\r\n\t\tObject.keys(item)\r\n\t\t\t.forEach((filePath) => {\r\n\t\t\t\tconst fileCoverage = item[filePath];\r\n\t\t\t\tthis.addFileCoverage(filePath, fileCoverage);\r\n\t\t\t});\r\n\t}\r\n\r\n\tgetFinalCoverage() {\r\n\t\tconst collector = new Collector();\r\n\r\n\t\tconst srcCoverage = this.sparceCoverageCollector.getFinalCoverage();\r\n\r\n\t\tcollector.add(Object.keys(srcCoverage)\r\n\t\t\t.filter((filePath) => !this.exclude(filePath))\r\n\t\t\t.reduce((obj, name) => {\r\n\t\t\t\tobj[name] = srcCoverage[name];\r\n\t\t\t\treturn obj;\r\n\t\t\t}, {}));\r\n\r\n\t\t/* refreshes the line counts for reports */\r\n\t\tcollector.getFinalCoverage();\r\n\r\n\t\treturn collector;\r\n\t}\r\n}\r\n\r\nmodule.exports.CoverageTransformer = CoverageTransformer;\r\n"]}